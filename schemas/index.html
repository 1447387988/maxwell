<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/robut.ico">

        <title>Schemas - Maxwell's Daemon</title>

        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.5.2/respond.min.js"></script>
        <![endif]-->
        <script src="http://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Maxwell's Daemon</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Overview</a>
                </li>
            
            
            
                <li >
                    <a href="../quickstart/">Quick Start</a>
                </li>
            
            
            
                <li >
                    <a href="../config/">Configuration</a>
                </li>
            
            
            
                <li >
                    <a href="../producers/">Producers</a>
                </li>
            
            
            
                <li >
                    <a href="../filtering/">Filtering</a>
                </li>
            
            
            
                <li >
                    <a href="../dataformat/">Data Format</a>
                </li>
            
            
            
                <li >
                    <a href="../encryption/">Encryption</a>
                </li>
            
            
            
                <li >
                    <a href="../bootstrapping/">Bootstrapping</a>
                </li>
            
            
            
                <li >
                    <a href="../monitoring/">Monitoring</a>
                </li>
            
            
            
                <li >
                    <a href="../embedding/">Embedding</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Schemas</a>
                </li>
            
            
            
                <li >
                    <a href="../compat/">Compat / Caveats</a>
                </li>
            
            
            
                <li >
                    <a href="../changelog/">Changelog</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../embedding/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../compat/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
            <div class="navbar-image-container"><img id="navbar-image" src="/img/maxwell_equals_2.png"></div>
        </div>
    </div>
</div>

        <a href="https://github.com/zendesk/maxwell"><img id="github-banner" style="position: absolute; top: 0; right: 0; border: 0; z-index: 1031;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
        <div class="container">
            <div class="col-md-2">&nbsp;<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        
          <li >
              <a href="..">Overview</a>
              
          </li>
        
          <li >
              <a href="../quickstart/">Quick Start</a>
              
          </li>
        
          <li >
              <a href="../config/">Configuration</a>
              
          </li>
        
          <li >
              <a href="../producers/">Producers</a>
              
          </li>
        
          <li >
              <a href="../filtering/">Filtering</a>
              
          </li>
        
          <li >
              <a href="../dataformat/">Data Format</a>
              
          </li>
        
          <li >
              <a href="../encryption/">Encryption</a>
              
          </li>
        
          <li >
              <a href="../bootstrapping/">Bootstrapping</a>
              
          </li>
        
          <li >
              <a href="../monitoring/">Monitoring</a>
              
          </li>
        
          <li >
              <a href="../embedding/">Embedding</a>
              
          </li>
        
          <li class="active">
              <a href="./">Schemas</a>
              
                  <ul class="nav">
                  
                      <li class="toctree-l3"><a href="#schema-storage">Schema storage</a>
                      <ul class="toctree-subnav">
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#master-failover">Master failover</a>
                      <ul class="toctree-subnav">
                      
                      </li>
                      </uL>
                  
                  </ul>
              
          </li>
        
          <li >
              <a href="../compat/">Compat / Caveats</a>
              
          </li>
        
          <li >
              <a href="../changelog/">Changelog</a>
              
          </li>
        
    </ul>
</div></div>
            <div class="col-md-10" role="main">

<h3 id="schema-storage">Schema storage</h3>
<hr />
<p>This document describes Maxwell's internal schema storage mechanism. Most users won't need to know how this works, but it can be useful in the rare case where something goes wrong.</p>
<p>MySQL binlogs give maxwell access to the raw bytes for each update that happens. In order to generate useful output, Maxwell needs to know the data type of every column, so that it can interpret the bytes as a number, string, boolean, etc.</p>
<p>There is a set of "base schema" tables in the maxwell database - <code>tables</code>, <code>columns</code>, <code>databases</code>. This is where we capture the initial schema, the first time Maxwell is run.</p>
<p>As time progresses, maxwell will see any modifications you make to the schema (these are part of the binlog). As each change occurs, Maxwell will generate an internal representation of what changed. Maxwell stores these diffs in the <code>schemas</code> table - each diff contains the following information to place it in the timeline of your database:</p>
<ul>
<li><code>binlog_file</code>, <code>binlog_position</code> (or <code>gtid_set</code>): the exact point in the binlog stream where the schema change occurred</li>
<li><code>deltas</code>: the internal representation of the schema change</li>
<li><code>base_schema_id</code>: the previous schema that this delta applies to</li>
<li><code>last_heartbeat_read</code>: the most recent maxwell heartbeat seen in the binlog prior to this change</li>
<li><code>server_id</code>: the server which this schema applies to</li>
</ul>
<p>This information creates a concrete timeline of the history of your schema for a given server. Given any binlog file+position (or gtid) and a last_heartbeat value, the current schema can be found by finding the "most recent" schema for this server_id, then following the chain of <code>base_schema_id</code> until it terminates (in a <code>null</code>, which means we've reached the initial captured schema).</p>
<p>"Most recent" should be fairly intuitive - firstly we sort by <code>last_heartbeat_read</code>, then by <code>binlog_file</code>, then <code>binlog_position</code>. We limit the search to values "before" the binlog position we're searching for, because we don't want to use a schema corresponding to a change that is "in the future" - i.e. further ahead in the binlog than our current position.</p>
<h3 id="master-failover">Master failover</h3>
<hr />
<p>Schemas are important for master failover. When Maxwell detects that it is talking to a new <code>server_id</code> (one that differs from its stored <code>position</code>), it attempts a master failover (if enabled). It searches backwards in the new servers binlog files, looking for an update to <code>maxwell.heartbeats</code> corresponding to the timestamp stored in its position table.</p>
<p>Once it finds this (unique) update, it knows the binlog location for both the old and new master which correspond to the exact same event.</p>
<p>Using this information, maxwell creates a merge point - it finds the active schema for the old master's stored position, and then creates a new schema entry with an empty delta, the new <code>server_id</code>, and a base_schema_id of the previous schema. In this way, Maxwell is able to create a chain of schema updates even across different servers with different sets of binlogs.</p></div>
        </div>

        

        <script src="../js/bootstrap-3.3.7.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
    </body>
    <script>
        jQuery(document).ready(function () {
            var shiftWindow = function() {
                scrollBy(0, -50)
            };

            //if (location.hash) shiftWindow();
            //window.addEventListener("hashchange", shiftWindow);

            jQuery("table").addClass("table table-condensed table-bordered table-hover");
            jQuery("#maxwell-header").append(
                jQuery("<img alt='The Daemon, maybe' src='/img/cyberiad_1.jpg' id='maxwell-daemon-image'>")
            );
        });
    </script>
</html>