<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/robut.ico">

        <title>Producers - Maxwell's Daemon</title>

        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/bootstrap-theme.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.5.2/respond.min.js"></script>
        <![endif]-->
        <script src="http://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">Maxwell's Daemon</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="..">Overview</a>
                </li>
            
            
            
                <li >
                    <a href="../quickstart/">Quick Start</a>
                </li>
            
            
            
                <li >
                    <a href="../config/">Configuration</a>
                </li>
            
            
            
                <li class="active">
                    <a href="./">Producers</a>
                </li>
            
            
            
                <li >
                    <a href="../filtering/">Filtering</a>
                </li>
            
            
            
                <li >
                    <a href="../dataformat/">Data Format</a>
                </li>
            
            
            
                <li >
                    <a href="../encryption/">Encryption</a>
                </li>
            
            
            
                <li >
                    <a href="../bootstrapping/">Bootstrapping</a>
                </li>
            
            
            
                <li >
                    <a href="../monitoring/">Monitoring</a>
                </li>
            
            
            
                <li >
                    <a href="../embedding/">Embedding</a>
                </li>
            
            
            
                <li >
                    <a href="../schemas/">Schemas</a>
                </li>
            
            
            
                <li >
                    <a href="../compat/">Compat / Caveats</a>
                </li>
            
            
            
                <li >
                    <a href="../changelog/">Changelog</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                <li >
                    <a rel="next" href="../config/">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../filtering/">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
            </ul>
            <div class="navbar-image-container"><img id="navbar-image" src="/img/maxwell_equals_2.png"></div>
        </div>
    </div>
</div>

        <a href="https://github.com/zendesk/maxwell"><img id="github-banner" style="position: absolute; top: 0; right: 0; border: 0; z-index: 1031;" src="https://camo.githubusercontent.com/365986a132ccd6a44c23a9169022c0b5c890c387/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png"></a>
        <div class="container">
            <div class="col-md-2">&nbsp;<div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
        
          <li >
              <a href="..">Overview</a>
              
          </li>
        
          <li >
              <a href="../quickstart/">Quick Start</a>
              
          </li>
        
          <li >
              <a href="../config/">Configuration</a>
              
          </li>
        
          <li class="active">
              <a href="./">Producers</a>
              
                  <ul class="nav">
                  
                      <li class="toctree-l3"><a href="#kafka">Kafka</a>
                      <ul class="toctree-subnav">
                      
                          <li class="toctree-l4" ><a href="#topic">Topic</a></li>
                      
                          <li class="toctree-l4" ><a href="#client-version">Client version</a></li>
                      
                          <li class="toctree-l4" ><a href="#extended-options">Extended options</a></li>
                      
                          <li class="toctree-l4" ><a href="#performant-properties">Performant properties</a></li>
                      
                          <li class="toctree-l4" ><a href="#at-least-once-properties">At-least-once properties</a></li>
                      
                          <li class="toctree-l4" ><a href="#keys">Keys</a></li>
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#partitioning">Partitioning</a>
                      <ul class="toctree-subnav">
                      
                          <li class="toctree-l4" ><a href="#kafka-partitioning">Kafka partitioning</a></li>
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#kinesis">Kinesis</a>
                      <ul class="toctree-subnav">
                      
                          <li class="toctree-l4" ><a href="#aws-credentials">AWS Credentials</a></li>
                      
                          <li class="toctree-l4" ><a href="#options">Options</a></li>
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#sqs">SQS</a>
                      <ul class="toctree-subnav">
                      
                          <li class="toctree-l4" ><a href="#aws-credentials_1">AWS Credentials</a></li>
                      
                          <li class="toctree-l4" ><a href="#options_1">Options</a></li>
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#google-cloud-pubsub">Google Cloud Pub/Sub</a>
                      <ul class="toctree-subnav">
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#rabbitmq">RabbitMQ</a>
                      <ul class="toctree-subnav">
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#redis">Redis</a>
                      <ul class="toctree-subnav">
                      
                      </li>
                      </uL>
                  
                      <li class="toctree-l3"><a href="#custom-producer">Custom Producer</a>
                      <ul class="toctree-subnav">
                      
                      </li>
                      </uL>
                  
                  </ul>
              
          </li>
        
          <li >
              <a href="../filtering/">Filtering</a>
              
          </li>
        
          <li >
              <a href="../dataformat/">Data Format</a>
              
          </li>
        
          <li >
              <a href="../encryption/">Encryption</a>
              
          </li>
        
          <li >
              <a href="../bootstrapping/">Bootstrapping</a>
              
          </li>
        
          <li >
              <a href="../monitoring/">Monitoring</a>
              
          </li>
        
          <li >
              <a href="../embedding/">Embedding</a>
              
          </li>
        
          <li >
              <a href="../schemas/">Schemas</a>
              
          </li>
        
          <li >
              <a href="../compat/">Compat / Caveats</a>
              
          </li>
        
          <li >
              <a href="../changelog/">Changelog</a>
              
          </li>
        
    </ul>
</div></div>
            <div class="col-md-10" role="main">

<h3 id="kafka">Kafka</h3>
<hr />
<h4 id="topic">Topic</h4>
<p>Maxwell writes to a kafka topic named "maxwell" by default. It can be static,
e.g. 'maxwell', or dynamic, e.g. <code>namespace_%{database}_%{table}</code>. In the
latter case 'database' and 'table' will be replaced with the values for the row
being processed. This can be changed with the <code>kafka_topic</code> option.</p>
<h4 id="client-version">Client version</h4>
<p>By default, maxwell uses the kafka 1.0.0 library. The <code>--kafka_version</code> flag
lets you choose an alternate library version: 0.8.2.2, 0.9.0.1, 0.10.0.1, 0.10.2.1 or
0.11.0.1, 1.0.0.  This flag is only available on the command line.</p>
<ul>
<li>The 0.8.2.2 client is only compatible with brokers running kafka 0.8.</li>
<li>The 0.10.0.x client is only compatible with brokers 0.10.0.x or later.</li>
<li>Mixing the 0.10 client with other versions can lead to serious performance impacts.
  For More details, <a href="http://kafka.apache.org/0100/documentation.html#upgrade_10_performance_impact">read about it here</a>.</li>
<li>The 0.11.0 client can talk to version 0.10.0 or newer brokers.</li>
<li>The 0.9.0.1 client is not compatible with brokers running kafka 0.8. The exception below will show in logs when that is the case:</li>
</ul>
<pre><code>ERROR Sender - Uncaught error in kafka producer I/O thread:
SchemaException: Error reading field 'throttle_time_ms': java.nio.BufferUnderflowException
</code></pre>

<h4 id="extended-options">Extended options</h4>
<p>Any options given to Maxwell that are prefixed with <code>kafka.</code> will be passed directly into the Kafka producer configuration
(with <code>kafka.</code> stripped off).  We use the "new producer" configuration, as described here:
<a href="http://kafka.apache.org/documentation.html#newproducerconfigs">http://kafka.apache.org/documentation.html#newproducerconfigs</a></p>
<h4 id="performant-properties">Performant properties</h4>
<p>These properties would give high throughput performance.</p>
<pre><code>kafka.acks = 1
kafka.compression.type = snappy
kafka.retries=0
</code></pre>

<h4 id="at-least-once-properties">At-least-once properties</h4>
<p>For at-least-once delivery, you will want something more like:</p>
<pre><code>kafka.acks = all
kafka.retries = 5 # or some larger number
</code></pre>

<p>And you will also want to set <code>min.insync.replicas</code> on Maxwell's output topic.</p>
<h4 id="keys">Keys</h4>
<p>Maxwell generates keys for its Kafka messages based upon a mysql row's primary key in JSON format:</p>
<pre><code>{ &quot;database&quot;:&quot;test_tb&quot;,&quot;table&quot;:&quot;test_tbl&quot;,&quot;pk.id&quot;:4,&quot;pk.part2&quot;:&quot;hello&quot;}
</code></pre>

<p>This key is designed to co-operate with Kafka's log compaction, which will save the last-known
value for a key, allowing Maxwell's Kafka stream to retain the last-known value for a row and act
as a source of truth.</p>
<p>The JSON-hash based key format is tricky to regenerate in a stable fashion.  If you have an
application in which you need to parse and re-generate keys, it's advised you enable
<code>--kafka_key_format=array</code>, which will generate kafka keys that can be parsed and re-output byte-for-byte.</p>
<h3 id="partitioning">Partitioning</h3>
<hr />
<p>Both Kafka and AWS Kinesis support the notion of partitioned streams.
Partitioning is controlled by <code>producer_partition_by</code>, which gives you the
option to split your stream by database, table, primary
key, or column data.  How you choose to partition will influence the consumers
of the maxwell stream.  A good rule of thumb is to use the finest-grained
partition scheme possible given serialization constraints.</p>
<p>To partition by column data, you must set both:</p>
<ul>
<li><code>producer_partition_columns</code>, a comma-separated list of column names, and</li>
<li><code>producer_partiton_by_fallback</code>. This may be (<em>database</em>, <em>table</em>,
  <em>primary_key</em>), and will be used as a default value when the column does not
  exist.</li>
</ul>
<p>When partitioning by column Maxwell will treat the values for the specified
columns as strings, concatenate them and use that value to partition the data.</p>
<h4 id="kafka-partitioning">Kafka partitioning</h4>
<p>A binlog event's partition is determined by the selected hash function and hash string as follows</p>
<pre><code>  HASH_FUNCTION(HASH_STRING) % TOPIC.NUMBER_OF_PARTITIONS
</code></pre>

<p>The HASH_FUNCTION is either java's <em>hashCode</em> or <em>murmurhash3</em>. The default
HASH_FUNCTION is <em>hashCode</em>. Murmurhash3 may be set with the
<code>kafka_partition_hash</code> option. The seed value for the murmurhash function is
hardcoded to 25342 in the MaxwellKafkaPartitioner class.</p>
<p>The HASH_STRING may be (<em>database</em>, <em>table</em>, <em>primary_key</em>, <em>transaction_id</em>, <em>column</em>).  The
default HASH_STRING is the <em>database</em>. The partitioning field can be configured
using the <code>producer_partition_by</code> option.</p>
<p>Maxwell will discover the number of partitions in its kafka topic upon boot.  This means that you should pre-create your kafka topics,
and with at least as many partitions as you have logical databases:</p>
<pre><code>bin/kafka-topics.sh --zookeeper ZK_HOST:2181 --create \
                    --topic maxwell --partitions 20 --replication-factor 2
</code></pre>

<p><a href="http://kafka.apache.org/documentation.html#quickstart">http://kafka.apache.org/documentation.html#quickstart</a></p>
<h3 id="kinesis">Kinesis</h3>
<hr />
<h4 id="aws-credentials">AWS Credentials</h4>
<p>You will need to obtain an IAM user that has the following permissions for the stream you are planning on producing to:</p>
<ul>
<li>"kinesis:PutRecord"</li>
<li>"kinesis:PutRecords"</li>
<li>"kinesis:DescribeStream"</li>
</ul>
<p>Additionally, the producer will need to be able to produce CloudWatch metrics which requires the following permission applied to the resource `*``:
- "cloudwatch:PutMetricData"</p>
<p>The resulting IAM policy document may look like this:</p>
<pre><code class="json">{
    &quot;Version&quot;: &quot;2012-10-17&quot;,
    &quot;Statement&quot;: [
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;kinesis:PutRecord&quot;,
                &quot;kinesis:PutRecords&quot;,
                &quot;kinesis:DescribeStream&quot;
            ],
            &quot;Resource&quot;: &quot;arn:aws:kinesis:us-west-2:123456789012:stream/my-stream&quot;
        },
        {
            &quot;Effect&quot;: &quot;Allow&quot;,
            &quot;Action&quot;: [
                &quot;cloudwatch:PutMetricData&quot;
            ],
            &quot;Resource&quot;: &quot;*&quot;
        }
    ]
}
</code></pre>

<p>See the <a href="http://docs.aws.amazon.com/streams/latest/dev/controlling-access.html#kinesis-using-iam-examples">AWS docs</a> for the latest examples on which permissions are needed.</p>
<p>The producer uses the <a href="http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html">DefaultAWSCredentialsProviderChain</a> class to gain aws credentials.
See the <a href="http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html">AWS docs</a> on how to setup the IAM user with the Default Credential Provider Chain.</p>
<h4 id="options">Options</h4>
<p>Set the output stream in <code>config.properties</code> by setting the <code>kinesis_stream</code> property.</p>
<p>The producer uses the <a href="http://docs.aws.amazon.com/streams/latest/dev/developing-producers-with-kpl.html">KPL (Kinesis Producer Library)</a> and uses the KPL built in configurations.
Copy <code>kinesis-producer-library.properties.example</code> to <code>kinesis-producer-library.properties</code> and configure the properties file to your needs.</p>
<p>You are <strong>required</strong> to configure the region. For example:</p>
<pre><code># set explicitly
Region=us-west-2
# or set with an environment variable
Region=$AWS_DEFAULT_REGION
</code></pre>

<p>By default, the KPL implements <a href="http://docs.aws.amazon.com/streams/latest/dev/kinesis-kpl-concepts.html#w2ab1c12b7b7c19c11">record aggregation</a>, which usually increases producer throughput by allowing you to increase the number of records sent per API call. However, aggregated records are encoded differently (using Google Protocol Buffers) than records that are not aggregated. Therefore, if you are not using the <a href="http://docs.aws.amazon.com/streams/latest/dev/developing-consumers-with-kcl.html">KCL (Kinesis Client Library)</a> to consume records (for example, you are using AWS Lambda) you will need to either disaggregate the records in your consumer (for example, by using the <a href="https://github.com/awslabs/kinesis-aggregation">AWS Kinesis Aggregation library</a>), or disable record aggregation in your <code>kinesis-producer-library.properties</code> configuration.</p>
<p>To disable aggregation, add the following to your configuration:</p>
<pre><code>AggregationEnabled=false
</code></pre>

<p>Remember: if you disable record aggregation, you will lose the benefit of potentially greater producer throughput.</p>
<h3 id="sqs">SQS</h3>
<hr />
<h4 id="aws-credentials_1">AWS Credentials</h4>
<p>You will need to obtain an IAM user that has the permission to access the SQS service. The SQS producer also uses <a href="http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/auth/DefaultAWSCredentialsProviderChain.html">DefaultAWSCredentialsProviderChain</a> to get AWS credentials.</p>
<p>See the <a href="http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/credentials.html">AWS docs</a> on how to setup the IAM user with the Default Credential Provider Chain.</p>
<p>In case you need to set up a different region also along with credentials then default one, see the <a href="http://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/setup-credentials.html#setup-credentials-setting-region">AWS docs</a>.</p>
<h4 id="options_1">Options</h4>
<p>Set the output queue in the <code>config.properties</code> by setting the <code>sqs_queue_uri</code> property to full SQS queue uri from AWS console.</p>
<p>The producer uses the <a href="http://docs.aws.amazon.com/AWSJavaSDK/latest/javadoc/com/amazonaws/services/sqs/AmazonSQSClient.html">AWS SQS SDK</a>.</p>
<h3 id="google-cloud-pubsub">Google Cloud Pub/Sub</h3>
<hr />
<p>In order to publish to Google Cloud Pub/Sub, you will need to obtain an IAM service account that has been granted the <code>roles/pubsub.publisher</code> role.</p>
<p>See the Google Cloud Platform docs for the <a href="https://cloud.google.com/pubsub/docs/access_control">latest examples of which permissions are needed</a>, as well as <a href="https://cloud.google.com/compute/docs/access/create-enable-service-accounts-for-instances">how to properly configure service accounts</a>.</p>
<p>Set the output stream in <code>config.properties</code> by setting the <code>pubsub_project_id</code> and <code>pubsub_topic</code> properties. Optionally configure a dedicated output topic
for DDL updates by setting the <code>ddl_pubsub_topic</code> property.</p>
<p>The producer uses the <a href="https://github.com/GoogleCloudPlatform/google-cloud-java/tree/master/google-cloud-pubsub">Google Cloud Java Library for Pub/Sub</a> and uses its built-in configurations.</p>
<h3 id="rabbitmq">RabbitMQ</h3>
<hr />
<p>To produce messages to RabbitMQ, you will need to specify a host in <code>config.properties</code> with <code>rabbitmq_host</code>. This is the only required property, everything else falls back to a sane default.</p>
<p>The remaining configurable properties are:
- <code>rabbitmq_user</code> - defaults to <strong>guest</strong>
- <code>rabbitmq_pass</code> - defaults to <strong>guest</strong>
- <code>rabbitmq_virtual_host</code> - defaults to <strong>/</strong>
- <code>rabbitmq_exchange</code> - defaults to <strong>maxwell</strong>
- <code>rabbitmq_exchange_type</code> - defaults to <strong>fanout</strong>
- <code>rabbitmq_exchange_durable</code> - defaults to <strong>false</strong>
- <code>rabbitmq_exchange_autodelete</code> - defaults to <strong>false</strong>
- <code>rabbitmq_routing_key_template</code> - defaults to <strong>%db%.%table%</strong>
    - This config controls the routing key, where <code>%db%</code> and <code>%table%</code> are placeholders that will be substituted at runtime
- <code>rabbitmq_message_persistent</code> - defaults to <strong>false</strong>
- <code>rabbitmq_declare_exchange</code> - defaults to <strong>true</strong></p>
<p>For more details on these options, you are encouraged to the read official RabbitMQ documentation here: https://www.rabbitmq.com/documentation.html</p>
<h3 id="redis">Redis</h3>
<hr />
<p>Set the output stream in <code>config.properties</code> by setting the <code>redis_pub_channel</code> property for redis_type = pubsub, <code>redis_stream_key</code> property for redis_type = xadd, or set the <code>redis_list_key</code> property when using redis_type = lpush.</p>
<p>Other configurable properties are:</p>
<ul>
<li><code>redis_host</code> - defaults to <strong>localhost</strong></li>
<li><code>redis_port</code> - defaults to <strong>6379</strong></li>
<li><code>redis_auth</code> - defaults to <strong>null</strong></li>
<li><code>redis_database</code> - defaults to <strong>0</strong></li>
<li><code>redis_type</code> - defaults to <strong>pubsub</strong></li>
<li><code>redis_pub_channel</code> - defaults to <strong>maxwell</strong></li>
<li><code>redis_list_key</code> - defaults to <strong>maxwell</strong></li>
<li><code>redis_stream_key</code> - defaults to <strong>maxwell</strong></li>
<li><code>redis_stream_json_key</code> - defaults to <strong>message</strong></li>
</ul>
<h3 id="custom-producer">Custom Producer</h3>
<hr />
<p>If none of the producers packaged with Maxwell meet your requirements, a custom producer can be added at runtime. The producer is responsible for processing the raw database rows. Note that your producer may receive DDL and heartbeat rows as well, but your producer can easily filter them out (see example).</p>
<p>In order to register your custom producer, you must implement the <code>ProducerFactory</code> interface, which is responsible for creating your custom <code>AbstractProducer</code>. Next, set the <code>custom_producer.factory</code> configuration property to your <code>ProducerFactory</code>'s fully qualified class name. Then add the custom <code>ProducerFactory</code> and all its dependencies to the $MAXWELL_HOME/lib directory.</p>
<p>Your custom producer will likely require configuration properties as well. For that, use the <code>custom_producer.*</code> property namespace. Those properties will be exposed to your producer via <code>MaxwellConfig.customProducerProperties</code>.</p>
<p>Custom producer factory and producer examples can be found here: <a href="https://github.com/zendesk/maxwell/tree/master/src/example/com/zendesk/maxwell/example/producerfactory">https://github.com/zendesk/maxwell/tree/master/src/example/com/zendesk/maxwell/example/producerfactory</a></p></div>
        </div>

        

        <script src="../js/bootstrap-3.3.7.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
    </body>
    <script>
        jQuery(document).ready(function () {
            var shiftWindow = function() {
                scrollBy(0, -50)
            };

            //if (location.hash) shiftWindow();
            //window.addEventListener("hashchange", shiftWindow);

            jQuery("table").addClass("table table-condensed table-bordered table-hover");
            jQuery("#maxwell-header").append(
                jQuery("<img alt='The Daemon, maybe' src='/img/cyberiad_1.jpg' id='maxwell-daemon-image'>")
            );
        });
    </script>
</html>